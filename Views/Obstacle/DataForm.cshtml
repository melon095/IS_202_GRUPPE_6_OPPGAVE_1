@*  Dette er en form for å registrere hindringer , henter fra mdoellen ObstacleData*@
@model Gruppe6Oppgave1.Models.ObstacleData
@{
    ViewData["Title"] = "Register Obstacle";
}

@* Dette er en seksjon for å registrere hindringer *@
<section class="max-w-4xl mx-auto mt-10 bg-white rounded-xl shadow-lg ring-1 ring-gray-200 p-6">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6">Obstacle Registration Form</h1>

   @*  En form som inneholder både felter og kart  *@
    <form asp-action="DataForm" method="post" class="space-y-6">

        @* Samler alt i en grid med to kolonner *@
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            @* Her er lengden mellom kollonene *@
            <div class="space-y-5">
                <div>
                  @*   Lager en boks hvor brukeren kan skrive inn informasjon *@
                    <label asp-for="Objektnavn" class="block text-sm font-medium text-gray-700 mb-1">Objekt navn</label>
                    <input asp-for="Objektnavn" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="Lysstolpe, flaggstang" />
                    <span asp-validation-for="Objektnavn" class="text-sm text-red-600"></span>
                </div>

                <div>
                    @*   Lager en boks hvor brukeren kan skrive inn informasjon *@
                    <label asp-for="Objekt_beskrivelse" class="block text-sm font-medium text-gray-700 mb-1">Objekt beskrivelse</label>
                    <input asp-for="Objekt_beskrivelse" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2" />
                    <span asp-validation-for="Objekt_beskrivelse" class="text-sm text-red-600"></span>
                </div>

                <div>
                    @*  Lager en boks hvor brukeren kan skrive inn informasjon *@
                    <label asp-for="Lattitude" class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                    <input asp-for="Lattitude" type="number" step="0.000001" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2" />
                    <span asp-validation-for="Lattitude" class="text-sm text-red-600"></span>
                </div>

                <div>
                    @*  Lager en boks hvor brukeren kan skrive inn informasjon *@
                    <label asp-for="Longitude" class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                    <input asp-for="Longitude" type="number" step="0.000001" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2" />
                    <span asp-validation-for="Longitude" class="text-sm text-red-600"></span>
                </div>

                <div>
                    @*   Lager en boks hvor brukeren kan skrive inn informasjon *@
                    <label asp-for="AMSL" class="block text-sm font-medium text-gray-700 mb-1">Height (foot)</label>
                    <input asp-for="AMSL" type="number" step="0.01" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2" />
                    <span asp-validation-for="AMSL" class="text-sm text-red-600"></span>
                </div>
            </div>

            @* Høyre kolonne: kart *@ 
            <div>
                <div id="regMap" class="w-full rounded-md border border-gray-200" style="height:60vh"></div>
            </div>
        </div>

        @* ÉN submit-knapp *@
        <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
            Submit Data
        </button>
    </form>
</section>

@section Styles {
    @* Importerer kart fra leaflet *@
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        @* rel sier at dette er en type stil, href er for å linke til en ekstern fil *@
}


@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    @* src gjør at vi kan inkludere leaflet kartet inn i siden *@
    <script>

        @* const gjør at en variabel ikke kan endres på *@
        const map = L.map('regMap').setView([60.472, 8.4689], 5);
        // Senterer kartet på Norge
        L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png',
        @*  Legger til kart fra kartverket *@
          { attribution: '© Kartverket' }).addTo(map);
          @* attribution sier hvem som har laget kartet, addTo legger det til i kartet *@

        @* Henter input feltene fra skjemaet som er laget tidligere *@       
        const latEl = document.getElementById('Lattitude');  
        const lngEl = document.getElementById('Longitude');
        @* Lager en markør som kan plasseres på kartet *@
        let marker;

        @*Passer på at lat og lng er gyldige desimaltall *@
        function validLatLng(lat, lng){
            @*Passer på at tallene er mellom -90 og 90 for lat, og -180 og 180 for lng *@
          return isFinite(lat) && isFinite(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
        }

        @*Lager en funksjon som gjør at kartet kan bevege seg etter input feltene *@
        function updateMarkerFromInputs(pan = true){
            @* Henter verdiene fra input feltene, og erstatter komma med punktum for desimaltall *@
          const lat = parseFloat((latEl?.value || '').replace(',', '.'));
          const lng = parseFloat((lngEl?.value || '').replace(',', '.'));
          @* Hvis lat og lng ikke er gyldige, avslutt funksjonen *@
          if (!validLatLng(lat, lng)) return;

            @* Hvis markøren ikke finnes, lag en ny markør på kartet. Hvis den finnes, oppdater posisjonen *@
          if (!marker) marker = L.marker([lat, lng]).addTo(map);
          else marker.setLatLng([lat, lng]);

          @* Flytt kartet til markørens posisjon, med zoomnivå minimum 12 *@
          if (pan) map.setView([lat, lng], Math.max(map.getZoom(), 12));
        }

        @* Når brukeren klikker på kartet, oppdater input feltene med klikkets lat og lng *@
        map.on('click', e => {
          const { lat, lng } = e.latlng;
          if (latEl) latEl.value = lat.toFixed(6);
          if (lngEl) lngEl.value = lng.toFixed(6);
          @* Oppdater markøren uten å flytte kartet (det er allerede der brukeren klikket) *@
          updateMarkerFromInputs(false);
        });

        @*Opdaterer kartet når brukeren skriver i input feltene *@
        ['input','change','blur'].forEach(evt => {
          if (latEl) latEl.addEventListener(evt, () => updateMarkerFromInputs(false));
          if (lngEl) lngEl.addEventListener(evt, () => updateMarkerFromInputs(false));
        });

        @* Hvis lat og lng er gyldige, oppdater markøren og flytt kartet til den posisjonen *@
        document.addEventListener('DOMContentLoaded', () => updateMarkerFromInputs(true));
    </script>

    @{
        @*  Legger til validering for skjemaet *@
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
